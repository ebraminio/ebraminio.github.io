<!DOCTYPE html>
<html manifest="application.appcache" dir="rtl" lang="fa">
    <head>
        <title>ابزار ویرایش</title>
        <style>
        body { background-color:#EEEEEE; }
        #container { margin: 2em; padding: 2em; }
        /* Night mode from: https://codepen.io/gijo-varghese/pen/xrxgJX */
        .night-mode { filter: invert(100%); background: #000; }
        .night-mode .exclude-night-mode{ filter: invert(100%); }
        </style>
    </head>
    <body>
        <div id="container">
            <textarea placeholder="این یک ویرایشگر سادهٔ فارسی با قابلیت ذخیرهٔ خودکار متن در مرورگرتان است." style="background-color: #EAEAEA; font-size: 120%; width: 100%; height: 20em; font-family: 'Segoe UI', 'Noto Sans Arabic', Tahoma, sans-serif;">متن</textarea>
            <div style="font-size: 80%; margin: .5em">
                <button onclick="superTool()">ابرابزار</button>
                <button onclick="persianDigits()">اعداد فارسی</button>
                <button onclick="persianSortTextButton()">ترتیب الفبا</button>
                <button onclick="uriDecode()">تبدیل از درصدی</button>
                <button onclick="copyToClipboard()">کپی</button>
                <button onclick="toggleNightMode()">حالت شب</button>
                <button id="replaceToolButton" onclick="showReplaceTool()">ابزار جایگزینی</button>
                <span id="replaceTool" style="display: none;">
                    <input id="replace-from" placeholder="از">
                    <input id="replace-to" placeholder="به">
                    <button onclick="applyReplace()">اعمال</button>
                    <label><input id="replace-isregex" type="checkbox"> عبارت باقاعده</label>
                    <span onclick="hideReplaceTool()" style="cursor: default;">❌</span>
                </span>
            </div>
            <script src="persiantools.js"></script>
            <script>
            function showReplaceTool() {
                document.getElementById('replaceToolButton').style.display = 'none';
                document.getElementById('replaceTool').style.display = 'inline';
            }

            function hideReplaceTool() {
                document.getElementById('replaceToolButton').style.display = 'inline';
                document.getElementById('replaceTool').style.display = 'none';
            }

            // stackoverflow.com/a/6969486
            function escapeRegExp(str) {
                return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
            }

            function applyReplace() {
                var pattern = document.getElementById('replace-from').value;
                if (!document.getElementById('replace-isregex').checked)
                    pattern = escapeRegExp(pattern);
                pattern = new RegExp(pattern, 'g');
                var replaceValue = document.getElementById('replace-to').value;
                document.querySelector('textarea').value =
                    document.querySelector('textarea').value.replace(pattern, replaceValue);
            }

            function superTool() {
                var text = document.querySelector('textarea').value;
                text = persianTools.applyOrthography(text);
                text = persianTools.applyZwnj(text);
                text = persianTools.punctuation(text);
                text = persianTools.toStandardPersianCharacters(text);
                document.querySelector('textarea').value = text;
            }

            function persianDigits() {
                document.querySelector('textarea').value = persianTools.toPersianDigits(document.querySelector('textarea').value);
            }

            function toggleNightMode() {
                if (document.body.classList.contains('night-mode'))
                    document.body.classList.remove('night-mode')
                else
                    document.body.classList.add('night-mode')
            }

            function dePersian(text) {
                return text
                    .replace(/ی/g, 'ي')
                    .replace(/ک/g, 'ك')
                    .replace(/ھ/g, 'ه')
                    .replace(/پ/g, 'بی')
                    .replace(/چ/g, 'جی')
                    .replace(/ڕ/g, 'ری')
                    .replace(/ژ/g, 'زی')
                    .replace(/ڤ/g, 'فی')
                    .replace(/ڵ/g, 'لی')
                    .replace(/گ/g, 'كی')
                    .replace(/ۆ/g, 'وی')
                    .replace(/ە/g, 'هی')
                    .replace(/ێ/g, 'يي');
            }

            function persianSortText(text) {
                return text.split('\n').sort(function (x, y) {
                    var keyX = dePersian(x),
                        keyY = dePersian(y);
                    if (keyX < keyY) {
                        return -1;
                    }
                    if (keyX > keyY) {
                        return 1;
                    }
                    return 0;
                }).join('\n');
            }

            function persianSortTextButton() {
                var editor = document.querySelector('textarea');
                editor.value = persianSortText(editor.value);
            }

            function uriDecode() {
                var editor = document.querySelector('textarea');
                editor.value = decodeURI(editor.value.replace(/%20/g, '\u200c\u200d\u200c')).replace(/\u200c\u200d\u200c/g, '%20');
            }

            function copyToClipboard() {
                document.querySelector('textarea').select();
                document.execCommand('copy');
            }

            document.addEventListener('DOMContentLoaded', function (event) {
                document.querySelector('textarea').value = localStorage.getItem('text') || '';
                if (localStorage.getItem('night-mode') === 'true') toggleNightMode();
            });
            
            setInterval(function () {
                localStorage.setItem('text', document.querySelector('textarea').value);
                localStorage.setItem('night-mode', document.body.classList.contains('night-mode'));
            }, 2000);
            </script>
        </div>
    </body>
</html>